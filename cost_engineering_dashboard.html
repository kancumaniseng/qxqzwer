<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Engineering Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .dashboard-container { max-width: 1400px; margin: 0 auto; }
        .dashboard-header { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .dashboard-header h1 { color: #333; font-size: 28px; margin-bottom: 5px; }
        .dashboard-header p { color: #666; font-size: 14px; }
        .info-box { background: #fef3c7; border: 2px solid #f59e0b; color: #92400e; padding: 20px; border-radius: 12px; margin-bottom: 25px; }
        .info-box h3 { margin-bottom: 10px; }
        .info-box ul { margin-left: 20px; margin-top: 10px; }
        .info-box li { margin: 5px 0; }
        .info-box code { background: #fed7aa; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .loading { text-align: center; padding: 40px; background: white; border-radius: 12px; margin: 20px 0; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .kpi-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }
        .kpi-value { font-size: 32px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .kpi-trend { font-size: 12px; color: #10b981; }
        .kpi-trend.down { color: #ef4444; }
        .main-content { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .card-header h2 { color: #333; font-size: 20px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .project-table { width: 100%; border-collapse: collapse; }
        .project-table thead { background: #f8f9fa; }
        .project-table th { padding: 12px; text-align: left; color: #666; font-weight: 600; font-size: 13px; text-transform: uppercase; }
        .project-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; color: #333; }
        .project-table tr:hover { background: #f8f9fa; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-on-track { background: #d1fae5; color: #065f46; }
        .status-at-risk { background: #fed7aa; color: #92400e; }
        .status-delayed { background: #fee2e2; color: #991b1b; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .team-member { display: flex; align-items: center; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; transition: all 0.3s ease; }
        .team-member:hover { background: #e5e7eb; }
        .member-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 15px; }
        .member-info { flex: 1; }
        .member-name { font-weight: 600; color: #333; margin-bottom: 5px; }
        .member-role { font-size: 12px; color: #666; }
        .workload-indicator { font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: 600; }
        .workload-low { background: #d1fae5; color: #065f46; }
        .workload-medium { background: #fed7aa; color: #92400e; }
        .workload-high { background: #fee2e2; color: #991b1b; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .modal-header h3 { color: #333; font-size: 22px; }
        .close { font-size: 28px; font-weight: bold; color: #999; cursor: pointer; }
        .close:hover { color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .notes-section { margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0; }
        .note-item { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; }
        .note-content { flex: 1; }
        .note-text { color: #333; margin-bottom: 5px; }
        .note-meta { font-size: 11px; color: #999; }
        .note-actions { margin-left: 10px; }
        .filter-section { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border: 2px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .filter-btn:hover, .filter-btn.active { border-color: #667eea; background: #667eea; color: white; }
        .refresh-btn { background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .refresh-btn:hover { background: #059669; }
        .error-message { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .success-message { background: #d1fae5; color: #065f46; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .action-icons { display: flex; gap: 8px; }
        .icon-btn { padding: 6px 10px; border: none; background: #f0f0f0; border-radius: 4px; cursor: pointer; }
        .icon-btn:hover { background: #667eea; color: white; }
        .data-source-info { background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .upload-section { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #667eea; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .upload-area:hover { background: #f8f9fa; border-color: #5568d3; }
        .upload-area.dragover { background: #e0e7ff; border-color: #4f46e5; }
        @media (max-width: 968px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Cost Engineering Dashboard</h1>
                    <p>Project Monitoring & Team Workload Management</p>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>‚ö†Ô∏è CORS Policy Issue - Solusi:</h3>
            <p>Browser memblokir akses langsung ke Google Sheets dari file HTML lokal. Ada 3 cara:</p>
            <ul>
                <li><strong>Cara 1 (RECOMMENDED):</strong> Upload file HTML ini ke web hosting (GitHub Pages, Netlify, atau hosting lain) - CORS akan otomatis work</li>
                <li><strong>Cara 2:</strong> Download CSV dari Google Sheets, lalu upload di dashboard ini menggunakan fitur upload di bawah</li>
                <li><strong>Cara 3:</strong> Install extension browser "Allow CORS" (Chrome) atau "CORS Everywhere" (Firefox) - temporary solution</li>
            </ul>
            <p style="margin-top: 15px;"><strong>Link Google Sheets CSV:</strong><br>
            <code>https://docs.google.com/spreadsheets/d/e/2PACX-1vSE4iCfy-ul3AvvtRn8crrMl-U8XTbcFQBdXSYTsEeMsUOfrzrmPH451fngepPaiT0wJ2RU11su9FD5/pub?output=csv</code></p>
        </div>

        <div class="upload-section">
            <h3 style="margin-bottom: 15px;">üì§ Upload CSV dari Google Sheets</h3>
            <p style="color: #666; margin-bottom: 15px;">Download CSV dari link di atas, lalu upload di sini:</p>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('csvFileInput').click()">
                <p style="font-size: 18px; margin-bottom: 10px;">üóÇÔ∏è Click atau Drag & Drop CSV File</p>
                <p style="font-size: 14px; color: #666;">File CSV dari Google Sheets</p>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
            </div>
        </div>

        <div id="errorMessage" style="display: none;"></div>

        <div id="dashboardContent" style="display: none;">
            <div class="data-source-info">
                <span>Data loaded: <span id="lastUpdate">-</span></span>
                <span style="font-size: 11px; color: #666;"><span id="rowCount">0</span> projects</span>
            </div>

            <div class="kpi-cards">
                <div class="kpi-card">
                    <h3>Total Projects</h3>
                    <div class="kpi-value" id="totalProjects">0</div>
                    <div class="kpi-trend" id="totalTrend">-</div>
                </div>
                <div class="kpi-card">
                    <h3>On Track</h3>
                    <div class="kpi-value" id="onTrackProjects">0</div>
                    <div class="kpi-trend" id="onTrackTrend">-</div>
                </div>
                <div class="kpi-card">
                    <h3>At Risk</h3>
                    <div class="kpi-value" id="atRiskProjects">0</div>
                    <div class="kpi-trend down" id="atRiskTrend">-</div>
                </div>
                <div class="kpi-card">
                    <h3>Avg Progress</h3>
                    <div class="kpi-value" id="avgProgress">0%</div>
                    <div class="kpi-trend" id="avgTrend">-</div>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Project Status</h2>
                        <button class="btn btn-primary" onclick="openAddProjectModal()">+ Tambah Project</button>
                    </div>

                    <div class="filter-section">
                        <button class="filter-btn active" onclick="filterProjects('all')">Semua</button>
                        <button class="filter-btn" onclick="filterProjects('on-track')">On Track</button>
                        <button class="filter-btn" onclick="filterProjects('at-risk')">At Risk</button>
                        <button class="filter-btn" onclick="filterProjects('delayed')">Delayed</button>
                        <button class="filter-btn" onclick="filterProjects('completed')">Completed</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="project-table">
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>PIC</th>
                                    <th>Progress</th>
                                    <th>Status</th>
                                    <th>Budget</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Team Workload</h2>
                    </div>
                    <div id="teamWorkloadList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Tambah Project Baru</h3>
                <span class="close" onclick="closeProjectModal()">&times;</span>
            </div>
            <form id="projectForm">
                <div class="form-group">
                    <label>Nama Project</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label>PIC</label>
                    <input type="text" id="projectPIC" required>
                </div>
                <div class="form-group">
                    <label>Progress (%)</label>
                    <input type="number" id="projectProgress" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="projectStatus" required>
                        <option value="on-track">On Track</option>
                        <option value="at-risk">At Risk</option>
                        <option value="delayed">Delayed</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Budget</label>
                    <input type="text" id="projectBudget" required>
                </div>
                <div class="notes-section">
                    <h4 style="margin-bottom: 15px;">Notes</h4>
                    <div id="notesList"></div>
                    <div class="form-group">
                        <textarea id="newNote" placeholder="Tambahkan catatan baru..."></textarea>
                    </div>
                    <button type="button" class="btn btn-success btn-sm" onclick="addNote()">+ Tambah Note</button>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">Simpan</button>
                    <button type="button" class="btn" onclick="closeProjectModal()" style="background: #e5e7eb;">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        var SKIP_ROWS = 2;
        var projects = [];
        var currentEditId = null;
        var currentProjectNotes = [];
        var currentFilter = 'all';

        // Load from localStorage on start
        var savedData = localStorage.getItem('projectsData');
        if (savedData) {
            projects = JSON.parse(savedData);
            document.getElementById('dashboardContent').style.display = 'block';
            document.getElementById('lastUpdate').textContent = localStorage.getItem('lastUpdate') || 'Cached';
            document.getElementById('rowCount').textContent = projects.length;
            initDashboard();
        }

        // File upload handling
        var uploadArea = document.getElementById('uploadArea');
        var fileInput = document.getElementById('csvFileInput');

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            var files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('Please upload a CSV file');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var csvText = e.target.result;
                parseAndLoadData(csvText);
            };
            reader.readAsText(file);
        }

        function parseAndLoadData(csvText) {
            try {
                var rows = parseCSV(csvText);

                console.log('Total rows:', rows.length);

                if (rows.length < SKIP_ROWS + 2) {
                    throw new Error('Data terlalu sedikit: ' + rows.length + ' rows');
                }

                var headers = rows[SKIP_ROWS];
                console.log('Headers:', headers);

                projects = [];
                for (var i = SKIP_ROWS + 1; i < rows.length; i++) {
                    var row = rows[i];
                    if (!row[0] || row[0].trim() === '') continue;

                    var project = {
                        id: i,
                        name: row[0] || 'Unnamed',
                        pic: row[1] || 'TBA',
                        progress: parseFloat(row[2]) || 0,
                        status: normalizeStatus(row[3]),
                        budget: row[4] || '0',
                        notes: parseNotes(row[5])
                    };
                    projects.push(project);
                }

                console.log('Projects loaded:', projects.length);

                if (projects.length === 0) {
                    throw new Error('Tidak ada data project valid');
                }

                localStorage.setItem('projectsData', JSON.stringify(projects));
                localStorage.setItem('lastUpdate', new Date().toLocaleString('id-ID'));

                document.getElementById('dashboardContent').style.display = 'block';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('id-ID');
                document.getElementById('rowCount').textContent = projects.length;

                showSuccess('Berhasil memuat ' + projects.length + ' projects!');
                initDashboard();

            } catch (error) {
                console.error('Error:', error);
                showError('Error parsing CSV: ' + error.message);
            }
        }

        function parseCSV(text) {
            var rows = [];
            var currentRow = [];
            var currentCell = '';
            var insideQuotes = false;

            for (var i = 0; i < text.length; i++) {
                var char = text[i];
                var nextChar = text[i + 1];

                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    currentRow.push(currentCell.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }

            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                rows.push(currentRow);
            }

            return rows;
        }

        function normalizeStatus(status) {
            if (!status) return 'on-track';
            status = status.toLowerCase().trim();
            if (status.indexOf('on') >= 0 || status.indexOf('track') >= 0) return 'on-track';
            if (status.indexOf('risk') >= 0) return 'at-risk';
            if (status.indexOf('delay') >= 0) return 'delayed';
            if (status.indexOf('complete') >= 0 || status.indexOf('done') >= 0) return 'completed';
            return 'on-track';
        }

        function parseNotes(notesText) {
            if (!notesText || notesText.trim() === '') return [];
            try {
                return JSON.parse(notesText);
            } catch (e) {
                return [{text: notesText, date: new Date().toISOString().split('T')[0]}];
            }
        }

        function showError(message) {
            var errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = '<div class="error-message">' + message + '</div>';
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            var errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = '<div class="success-message">' + message + '</div>';
            errorDiv.style.display = 'block';
            setTimeout(function() { errorDiv.style.display = 'none'; }, 5000);
        }

        function initDashboard() {
            updateKPIs();
            renderProjects(currentFilter);
            renderTeamWorkload();
        }

        function updateKPIs() {
            var total = projects.length;
            var onTrack = 0;
            var atRisk = 0;
            var totalProgress = 0;

            for (var i = 0; i < projects.length; i++) {
                if (projects[i].status === 'on-track') onTrack++;
                if (projects[i].status === 'at-risk') atRisk++;
                totalProgress += projects[i].progress;
            }

            var avgProgress = total > 0 ? Math.round(totalProgress / total) : 0;

            document.getElementById('totalProjects').textContent = total;
            document.getElementById('onTrackProjects').textContent = onTrack;
            document.getElementById('atRiskProjects').textContent = atRisk;
            document.getElementById('avgProgress').textContent = avgProgress + '%';

            document.getElementById('totalTrend').textContent = total + ' active projects';
            document.getElementById('onTrackTrend').textContent = total > 0 ? Math.round((onTrack/total)*100) + '% success rate' : '0%';
            document.getElementById('atRiskTrend').textContent = atRisk > 0 ? 'Perlu perhatian' : 'All good!';
            document.getElementById('avgTrend').textContent = avgProgress >= 50 ? 'Good progress' : 'Needs attention';
        }

        function renderProjects(filter) {
            currentFilter = filter;
            var tbody = document.getElementById('projectTableBody');
            var filteredProjects = [];

            if (filter === 'all') {
                filteredProjects = projects;
            } else {
                for (var i = 0; i < projects.length; i++) {
                    if (projects[i].status === filter) filteredProjects.push(projects[i]);
                }
            }

            if (filteredProjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">Tidak ada data</td></tr>';
                return;
            }

            var html = '';
            for (var i = 0; i < filteredProjects.length; i++) {
                var p = filteredProjects[i];
                html += '<tr>';
                html += '<td><strong>' + p.name + '</strong></td>';
                html += '<td>' + p.pic + '</td>';
                html += '<td><div style="display:flex;align-items:center;gap:10px;"><div class="progress-bar" style="flex:1;"><div class="progress-fill" style="width:' + p.progress + '%"></div></div><span style="font-size:12px;font-weight:600;">' + p.progress + '%</span></div></td>';
                html += '<td><span class="status-badge status-' + p.status + '">' + getStatusText(p.status) + '</span></td>';
                html += '<td>' + p.budget + '</td>';
                html += '<td><div class="action-icons"><button class="icon-btn" onclick="editProject(' + p.id + ')">Edit</button><button class="icon-btn" onclick="deleteProject(' + p.id + ')">Delete</button></div></td>';
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }

        function renderTeamWorkload() {
            var teamList = document.getElementById('teamWorkloadList');
            var workloadMap = {};

            for (var i = 0; i < projects.length; i++) {
                var pic = projects[i].pic;
                if (!workloadMap[pic]) {
                    workloadMap[pic] = {count: 0};
                }
                workloadMap[pic].count++;
            }

            var html = '';
            for (var name in workloadMap) {
                var count = workloadMap[name].count;
                var workload = count <= 2 ? 'low' : count <= 3 ? 'medium' : 'high';
                var workloadText = workload === 'low' ? 'Ringan' : workload === 'medium' ? 'Sedang' : 'Tinggi';

                html += '<div class="team-member">';
                html += '<div class="member-avatar">' + name.charAt(0).toUpperCase() + '</div>';
                html += '<div class="member-info"><div class="member-name">' + name + '</div><div class="member-role">' + count + ' Projects</div></div>';
                html += '<span class="workload-indicator workload-' + workload + '">' + workloadText + '</span>';
                html += '</div>';
            }

            teamList.innerHTML = html || '<p style="text-align:center;color:#999;">No data</p>';
        }

        function filterProjects(status) {
            var buttons = document.querySelectorAll('.filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            event.target.classList.add('active');
            renderProjects(status);
        }

        function getStatusText(status) {
            if (status === 'on-track') return 'On Track';
            if (status === 'at-risk') return 'At Risk';
            if (status === 'delayed') return 'Delayed';
            if (status === 'completed') return 'Completed';
            return status;
        }

        function openAddProjectModal() {
            currentEditId = null;
            currentProjectNotes = [];
            document.getElementById('modalTitle').textContent = 'Tambah Project Baru';
            document.getElementById('projectForm').reset();
            document.getElementById('notesList').innerHTML = '';
            document.getElementById('projectModal').style.display = 'block';
        }

        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function editProject(id) {
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === id) {
                    var project = projects[i];
                    currentEditId = id;
                    currentProjectNotes = project.notes.slice();
                    document.getElementById('modalTitle').textContent = 'Edit Project';
                    document.getElementById('projectName').value = project.name;
                    document.getElementById('projectPIC').value = project.pic;
                    document.getElementById('projectProgress').value = project.progress;
                    document.getElementById('projectStatus').value = project.status;
                    document.getElementById('projectBudget').value = project.budget;
                    renderNotesList();
                    document.getElementById('projectModal').style.display = 'block';
                    break;
                }
            }
        }

        function deleteProject(id) {
            if (confirm('Hapus project ini?')) {
                var newProjects = [];
                for (var i = 0; i < projects.length; i++) {
                    if (projects[i].id !== id) newProjects.push(projects[i]);
                }
                projects = newProjects;
                localStorage.setItem('projectsData', JSON.stringify(projects));
                initDashboard();
                showSuccess('Project dihapus');
            }
        }

        function addNote() {
            var noteText = document.getElementById('newNote').value.trim();
            if (!noteText) return;
            var note = {text: noteText, date: new Date().toISOString().split('T')[0]};
            currentProjectNotes.push(note);
            document.getElementById('newNote').value = '';
            renderNotesList();
        }

        function deleteNote(index) {
            if (confirm('Hapus catatan?')) {
                currentProjectNotes.splice(index, 1);
                renderNotesList();
            }
        }

        function renderNotesList() {
            var notesList = document.getElementById('notesList');
            if (currentProjectNotes.length === 0) {
                notesList.innerHTML = '<p style="color:#999;font-size:13px;">Belum ada catatan.</p>';
                return;
            }
            var html = '';
            for (var i = 0; i < currentProjectNotes.length; i++) {
                var note = currentProjectNotes[i];
                html += '<div class="note-item"><div class="note-content"><div class="note-text">' + note.text + '</div><div class="note-meta">' + note.date + '</div></div><div class="note-actions"><button class="btn btn-danger btn-sm" onclick="deleteNote(' + i + ')">Hapus</button></div></div>';
            }
            notesList.innerHTML = html;
        }

        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var projectData = {
                name: document.getElementById('projectName').value,
                pic: document.getElementById('projectPIC').value,
                progress: parseInt(document.getElementById('projectProgress').value),
                status: document.getElementById('projectStatus').value,
                budget: document.getElementById('projectBudget').value,
                notes: currentProjectNotes
            };

            if (currentEditId) {
                for (var i = 0; i < projects.length; i++) {
                    if (projects[i].id === currentEditId) {
                        projects[i] = {id: currentEditId, name: projectData.name, pic: projectData.pic, progress: projectData.progress, status: projectData.status, budget: projectData.budget, notes: projectData.notes};
                        break;
                    }
                }
            } else {
                var maxId = 0;
                for (var i = 0; i < projects.length; i++) {
                    if (projects[i].id > maxId) maxId = projects[i].id;
                }
                projectData.id = maxId + 1;
                projects.push(projectData);
            }

            localStorage.setItem('projectsData', JSON.stringify(projects));
            closeProjectModal();
            initDashboard();
            showSuccess('Data tersimpan');
        });

        window.onclick = function(event) {
            if (event.target == document.getElementById('projectModal')) {
                closeProjectModal();
            }
        }
    </script>
</body>
</html>