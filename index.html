<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Engineering Dashboard 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; min-height: 100vh; }

        /* Header Gradient Style */
        .dashboard-header { 
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%); 
            padding: 30px 40px; 
            color: white; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .header-content { max-width: 1400px; margin: 0 auto; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .logo { font-size: 36px; }
        .header-title h1 { font-size: 32px; font-weight: 700; letter-spacing: 1px; }
        .header-subtitle { font-size: 14px; opacity: 0.95; margin-bottom: 5px; }
        .header-update { font-size: 13px; opacity: 0.9; }
        .refresh-btn { 
            background: rgba(255,255,255,0.2); 
            color: white; 
            padding: 10px 20px; 
            border: 2px solid rgba(255,255,255,0.3); 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .refresh-icon { font-size: 16px; transition: transform 0.3s ease; }
        .refresh-icon.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Container */
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 30px 40px; }

        /* Tab Navigation */
        .tab-navigation { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 30px; 
            background: white; 
            padding: 10px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .tab-btn { 
            padding: 12px 24px; 
            border: none; 
            background: transparent; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 15px; 
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn:hover { background: #f1f5f9; color: #334155; }
        .tab-btn.active { background: #3b82f6; color: white; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .kpi-card.blue { border-left-color: #3b82f6; }
        .kpi-card.green { border-left-color: #10b981; }
        .kpi-card.orange { border-left-color: #f59e0b; }
        .kpi-card.red { border-left-color: #ef4444; }
        .kpi-card.purple { border-left-color: #8b5cf6; }
        .kpi-card.cyan { border-left-color: #06b6d4; }
        .kpi-label { 
            font-size: 12px; 
            color: #64748b; 
            text-transform: uppercase; 
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 12px; 
        }
        .kpi-value { 
            font-size: 36px; 
            font-weight: 700; 
            color: #1e293b; 
            margin-bottom: 8px; 
            line-height: 1;
        }
        .kpi-subtitle { font-size: 13px; color: #94a3b8; }

        /* Main Card */
        .main-card { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 20px; 
            border-bottom: 2px solid #f1f5f9; 
        }
        .card-title { 
            font-size: 20px; 
            font-weight: 700; 
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Table Styles */
        .data-table { 
            width: 100%; 
            border-collapse: separate;
            border-spacing: 0;
        }
        .data-table thead { background: #f8fafc; }
        .data-table th { 
            padding: 14px 16px; 
            text-align: left; 
            color: #475569; 
            font-weight: 700; 
            font-size: 12px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }
        .data-table td { 
            padding: 16px; 
            border-bottom: 1px solid #f1f5f9; 
            color: #334155;
            font-size: 14px;
        }
        .data-table tbody tr { transition: all 0.2s ease; }
        .data-table tbody tr:hover { background: #f8fafc; }

        /* Status Badges */
        .status-badge { 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: inline-block;
        }
        .status-on-track { background: #d1fae5; color: #065f46; }
        .status-at-risk { background: #fed7aa; color: #92400e; }
        .status-delayed { background: #fee2e2; color: #991b1b; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .status-pending { background: #e0e7ff; color: #3730a3; }
        .status-sourcing { background: #fef3c7; color: #92400e; }
        .status-negosiasi { background: #fef3c7; color: #f59e0b; }

        .priority-critical { background: #fee2e2; color: #991b1b; }
        .priority-high { background: #fed7aa; color: #c2410c; }
        .priority-normal { background: #dbeafe; color: #1e40af; }
        .priority-low { background: #d1fae5; color: #065f46; }

        /* Progress Bar */
        .progress-container { display: flex; align-items: center; gap: 12px; }
        .progress-bar { 
            flex: 1; 
            height: 10px; 
            background: #e2e8f0; 
            border-radius: 10px; 
            overflow: hidden;
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #3b82f6 0%, #06b6d4 100%); 
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        .progress-text { 
            font-size: 13px; 
            font-weight: 700; 
            color: #475569;
            min-width: 45px;
            text-align: right;
        }

        /* Buttons */
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-sm { padding: 6px 14px; font-size: 13px; }
        .btn-icon { 
            padding: 8px 12px; 
            background: #f8fafc; 
            border: 1px solid #e2e8f0;
            color: #475569;
        }
        .btn-icon:hover { background: #f1f5f9; border-color: #cbd5e1; }

        /* Loading & Messages */
        .loading { 
            text-align: center; 
            padding: 60px 40px; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .loading-spinner { 
            border: 4px solid #f1f5f9; 
            border-top: 4px solid #3b82f6; 
            border-radius: 50%; 
            width: 48px; 
            height: 48px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px; 
        }
        .message { 
            padding: 16px 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .message-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .message-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .message-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }

        /* Filter Section */
        .filter-section { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 25px; 
            flex-wrap: wrap;
        }
        .filter-chip { 
            padding: 8px 18px; 
            border: 2px solid #e2e8f0; 
            background: white; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
        }
        .filter-chip:hover { border-color: #cbd5e1; background: #f8fafc; }
        .filter-chip.active { 
            border-color: #3b82f6; 
            background: #3b82f6; 
            color: white;
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
        }

        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            background: white; 
            margin: 60px auto; 
            padding: 0; 
            border-radius: 16px; 
            max-width: 700px; 
            max-height: 85vh; 
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header { 
            padding: 25px 30px; 
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }
        .modal-header h3 { 
            font-size: 22px; 
            font-weight: 700; 
            color: #1e293b;
        }
        .modal-close { 
            font-size: 28px; 
            font-weight: 700; 
            color: #94a3b8; 
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }
        .modal-close:hover { color: #475569; }
        .modal-body { 
            padding: 30px; 
            max-height: calc(85vh - 160px); 
            overflow-y: auto; 
        }
        .modal-footer { 
            padding: 20px 30px; 
            border-top: 2px solid #f1f5f9;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: #f8fafc;
        }

        /* Form Styles */
        .form-group { margin-bottom: 24px; }
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            color: #475569; 
            font-weight: 600;
            font-size: 14px;
        }
        .form-input, .form-textarea, .form-select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 14px;
            color: #334155;
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus { 
            outline: none; 
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .form-textarea { 
            resize: vertical; 
            min-height: 100px; 
            font-family: inherit;
        }

        /* Data Source Info */
        .data-info { 
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); 
            color: #1e40af; 
            padding: 14px 20px; 
            border-radius: 10px; 
            font-size: 13px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 968px) { 
            .dashboard-container { padding: 20px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .header-top { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
        @media (max-width: 640px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .tab-navigation { flex-wrap: wrap; }
        }

        /* No Data State */
        .no-data { 
            text-align: center; 
            padding: 60px 20px; 
            color: #94a3b8;
        }
        .no-data-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        .no-data-text { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .no-data-subtext { font-size: 14px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-top">
                <div class="header-title">
                    <span class="logo">üìä</span>
                    <div>
                        <h1>COST ENGINEERING DASHBOARD 2026</h1>
                        <div class="header-subtitle">Cost Engineering Project Portfolio | PT Pertamina</div>
                        <div class="header-update">Updated: <span id="headerUpdate">Loading...</span></div>
                    </div>
                </div>
                <button class="refresh-btn" id="refreshBtn" onclick="loadGoogleSheetData()">
                    <span class="refresh-icon" id="refreshIcon">üîÑ</span>
                    <span id="refreshText">Refresh Data</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="dashboard-container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('projects')">
                üìã Dashboard Projects
            </button>
            <button class="tab-btn" onclick="switchTab('team')">
                üë• Team Performance
            </button>
            <button class="tab-btn" onclick="switchTab('owner')">
                üìà Owner Rankings
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p style="color: #64748b; font-weight: 600;">Loading data dari Google Sheets...</p>
        </div>

        <!-- Error/Success Messages -->
        <div id="messageContainer"></div>

        <!-- Projects Tab -->
        <div id="projectsTab" class="tab-content">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card blue">
                    <div class="kpi-label">Total Projects</div>
                    <div class="kpi-value" id="totalProjects">0</div>
                    <div class="kpi-subtitle">Q1 2026 Portfolio</div>
                </div>
                <div class="kpi-card green">
                    <div class="kpi-label">Completed</div>
                    <div class="kpi-value" id="completedProjects">0</div>
                    <div class="kpi-subtitle" id="completionRate">0% Done Rate</div>
                </div>
                <div class="kpi-card orange">
                    <div class="kpi-label">Active</div>
                    <div class="kpi-value" id="activeProjects">0</div>
                    <div class="kpi-subtitle">In Progress</div>
                </div>
                <div class="kpi-card red">
                    <div class="kpi-label">Critical/Overdue</div>
                    <div class="kpi-value" id="criticalProjects">0</div>
                    <div class="kpi-subtitle">Needs Attention</div>
                </div>
                <div class="kpi-card purple">
                    <div class="kpi-label">Total Budget</div>
                    <div class="kpi-value" id="totalBudget">0</div>
                    <div class="kpi-subtitle">IDR (Billion)</div>
                </div>
                <div class="kpi-card cyan">
                    <div class="kpi-label">Avg Progress</div>
                    <div class="kpi-value" id="avgProgress">0%</div>
                    <div class="kpi-subtitle">Overall Progress</div>
                </div>
            </div>

            <!-- Data Source Info -->
            <div class="data-info">
                <span>üìä Data source: Google Sheets | Last updated: <strong id="lastUpdate">-</strong></span>
                <span><strong id="rowCount">0</strong> projects loaded</span>
            </div>

            <!-- Projects Table Card -->
            <div class="main-card">
                <div class="card-header">
                    <h2 class="card-title">
                        üìã Active Projects
                        <span style="font-size: 14px; font-weight: 500; color: #64748b;" id="activeCount">(0)</span>
                    </h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-sm" onclick="exportToExcel()">
                            üì• Export Excel
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="openAddModal()">
                            ‚ûï Add Project
                        </button>
                    </div>
                </div>

                <!-- Filter Chips -->
                <div class="filter-section">
                    <div class="filter-chip active" onclick="filterProjects('all')">All Projects</div>
                    <div class="filter-chip" onclick="filterProjects('on-track')">‚úÖ On Track</div>
                    <div class="filter-chip" onclick="filterProjects('at-risk')">‚ö†Ô∏è At Risk</div>
                    <div class="filter-chip" onclick="filterProjects('delayed')">üî¥ Delayed</div>
                    <div class="filter-chip" onclick="filterProjects('completed')">‚úîÔ∏è Completed</div>
                </div>

                <!-- Projects Table -->
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">NO</th>
                                <th style="min-width: 300px;">PROJECT NAME</th>
                                <th style="width: 120px;">OWNER</th>
                                <th style="width: 100px;">PIC</th>
                                <th style="width: 180px;">PROGRESS</th>
                                <th style="width: 130px;">STATUS</th>
                                <th style="width: 150px;">BUDGET</th>
                                <th style="width: 120px;">DEADLINE</th>
                                <th style="width: 100px;">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="projectTableBody">
                            <tr>
                                <td colspan="9" class="no-data">
                                    <div class="no-data-icon">üì≠</div>
                                    <div class="no-data-text">No data available</div>
                                    <div class="no-data-subtext">Click Refresh Data to load from Google Sheets</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Team Tab -->
        <div id="teamTab" class="tab-content" style="display: none;">
            <div class="kpi-grid">
                <div class="kpi-card blue">
                    <div class="kpi-label">Total Team Members</div>
                    <div class="kpi-value" id="totalTeam">0</div>
                    <div class="kpi-subtitle">Cost Engineering Team</div>
                </div>
                <div class="kpi-card red">
                    <div class="kpi-label">Overload</div>
                    <div class="kpi-value" id="overloadTeam">0</div>
                    <div class="kpi-subtitle">High Workload</div>
                </div>
                <div class="kpi-card green">
                    <div class="kpi-label">Balanced Load</div>
                    <div class="kpi-value" id="balancedTeam">0</div>
                    <div class="kpi-subtitle">OK Status</div>
                </div>
                <div class="kpi-card orange">
                    <div class="kpi-label">Underload</div>
                    <div class="kpi-value" id="underloadTeam">0</div>
                    <div class="kpi-subtitle">Can Take More</div>
                </div>
            </div>

            <div class="main-card">
                <div class="card-header">
                    <h2 class="card-title">üë• Team Performance Analysis</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PIC NAME</th>
                                <th>CODE</th>
                                <th>SPECIALIZATION</th>
                                <th>ONGOING</th>
                                <th>SUPPORT</th>
                                <th>DONE</th>
                                <th>TOTAL</th>
                                <th>LOAD STATUS</th>
                                <th>PERFORMANCE</th>
                            </tr>
                        </thead>
                        <tbody id="teamTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Owner Tab -->
        <div id="ownerTab" class="tab-content" style="display: none;">
            <div class="kpi-grid">
                <div class="kpi-card blue">
                    <div class="kpi-label">Total Companies</div>
                    <div class="kpi-value" id="totalOwners">0</div>
                    <div class="kpi-subtitle">Active Owners</div>
                </div>
                <div class="kpi-card green">
                    <div class="kpi-label">Top Owner (Projects)</div>
                    <div class="kpi-value" id="topOwnerProjects">-</div>
                    <div class="kpi-subtitle" id="topOwnerName">-</div>
                </div>
                <div class="kpi-card purple">
                    <div class="kpi-label">Top Owner (Value)</div>
                    <div class="kpi-value" id="topOwnerValue">-</div>
                    <div class="kpi-subtitle" id="topOwnerValueName">-</div>
                </div>
                <div class="kpi-card cyan">
                    <div class="kpi-label">Highest Budget</div>
                    <div class="kpi-value" id="highestBudget">-</div>
                    <div class="kpi-subtitle">Single Project</div>
                </div>
            </div>

            <div class="main-card">
                <div class="card-header">
                    <h2 class="card-title">üìà Owner Performance Metrics</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>COMPANY NAME</th>
                                <th>CODE</th>
                                <th>PROJECTS</th>
                                <th>TOTAL BUDGET</th>
                                <th>AVG PROGRESS</th>
                                <th>COMPLETION RATE</th>
                            </tr>
                        </thead>
                        <tbody id="ownerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Project</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" id="projectName" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Owner</label>
                            <input type="text" class="form-input" id="projectOwner" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">PIC</label>
                            <input type="text" class="form-input" id="projectPIC" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Progress (%)</label>
                            <input type="number" class="form-input" id="projectProgress" min="0" max="100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="projectStatus" required>
                                <option value="on-track">On Track</option>
                                <option value="at-risk">At Risk</option>
                                <option value="delayed">Delayed</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Budget (IDR Billion)</label>
                            <input type="text" class="form-input" id="projectBudget" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Deadline</label>
                            <input type="date" class="form-input" id="projectDeadline" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="projectNotes" placeholder="Add project notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">üíæ Save Project</button>
            </div>
        </div>
    </div>

    <script>
        var SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSE4iCfy-ul3AvvtRn8crrMl-U8XTbcFQBdXSYTsEeMsUOfrzrmPH451fngepPaiT0wJ2RU11su9FD5/pub?output=csv';
        var SKIP_ROWS = 2;
        var projects = [];
        var currentFilter = 'all';
        var currentTab = 'projects';
        var isLoading = false;
        var editingId = null;

        // Load data on page load
        window.addEventListener('DOMContentLoaded', function() {
            var cached = localStorage.getItem('projectsData');
            if (cached) {
                projects = JSON.parse(cached);
                updateAllViews();
            }
            loadGoogleSheetData();
        });

        function loadGoogleSheetData() {
            if (isLoading) return;
            isLoading = true;

            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('refreshIcon').classList.add('spinning');
            document.getElementById('refreshText').textContent = 'Loading...';

            fetch(SHEET_URL)
                .then(function(response) {
                    if (!response.ok) throw new Error('Failed to fetch');
                    return response.text();
                })
                .then(function(csv) {
                    var rows = parseCSV(csv);
                    projects = [];

                    for (var i = SKIP_ROWS + 1; i < rows.length; i++) {
                        var row = rows[i];
                        if (!row[0] || row[0].trim() === '') continue;

                        projects.push({
                            id: i,
                            name: row[0] || 'Unnamed',
                            owner: row[1] || 'Unknown',
                            pic: row[2] || 'TBA',
                            progress: parseFloat(row[3]) || 0,
                            status: normalizeStatus(row[4]),
                            budget: row[5] || '0',
                            deadline: row[6] || '-',
                            notes: row[7] || ''
                        });
                    }

                    localStorage.setItem('projectsData', JSON.stringify(projects));
                    var now = new Date().toLocaleString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    localStorage.setItem('lastUpdate', now);

                    updateAllViews();
                    showMessage('success', 'Successfully loaded ' + projects.length + ' projects from Google Sheets!');
                })
                .catch(function(error) {
                    showMessage('error', 'Failed to load data: ' + error.message);
                    var cached = localStorage.getItem('projectsData');
                    if (cached) {
                        projects = JSON.parse(cached);
                        updateAllViews();
                    }
                })
                .finally(function() {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('refreshBtn').disabled = false;
                    document.getElementById('refreshIcon').classList.remove('spinning');
                    document.getElementById('refreshText').textContent = 'Refresh Data';
                    isLoading = false;
                });
        }

        function parseCSV(text) {
            var rows = [];
            var row = [];
            var cell = '';
            var inQuotes = false;

            for (var i = 0; i < text.length; i++) {
                var c = text[i];
                var next = text[i + 1];

                if (c === '"') {
                    if (inQuotes && next === '"') {
                        cell += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (c === ',' && !inQuotes) {
                    row.push(cell.trim());
                    cell = '';
                } else if ((c === '\n' || c === '\r') && !inQuotes) {
                    if (c === '\r' && next === '\n') i++;
                    row.push(cell.trim());
                    rows.push(row);
                    row = [];
                    cell = '';
                } else {
                    cell += c;
                }
            }

            if (cell || row.length) {
                row.push(cell.trim());
                rows.push(row);
            }

            return rows;
        }

        function normalizeStatus(status) {
            if (!status) return 'on-track';
            status = status.toLowerCase();
            if (status.indexOf('track') >= 0) return 'on-track';
            if (status.indexOf('risk') >= 0) return 'at-risk';
            if (status.indexOf('delay') >= 0) return 'delayed';
            if (status.indexOf('complete') >= 0) return 'completed';
            return 'on-track';
        }

        function updateAllViews() {
            updateKPIs();
            renderProjectsTable(currentFilter);
            renderTeamTable();
            renderOwnerTable();

            var lastUpdate = localStorage.getItem('lastUpdate') || '-';
            document.getElementById('lastUpdate').textContent = lastUpdate;
            document.getElementById('headerUpdate').textContent = lastUpdate;
            document.getElementById('rowCount').textContent = projects.length;
        }

        function updateKPIs() {
            var total = projects.length;
            var completed = projects.filter(function(p) { return p.status === 'completed'; }).length;
            var active = projects.filter(function(p) { return p.status !== 'completed'; }).length;
            var critical = projects.filter(function(p) { return p.status === 'delayed' || p.status === 'at-risk'; }).length;

            var totalBudgetNum = 0;
            var totalProgress = 0;
            projects.forEach(function(p) {
                totalBudgetNum += parseFloat(p.budget) || 0;
                totalProgress += p.progress;
            });

            var avgProg = total > 0 ? Math.round(totalProgress / total) : 0;
            var compRate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalProjects').textContent = total;
            document.getElementById('completedProjects').textContent = completed;
            document.getElementById('completionRate').textContent = compRate + '% Done Rate';
            document.getElementById('activeProjects').textContent = active;
            document.getElementById('criticalProjects').textContent = critical;
            document.getElementById('totalBudget').textContent = (totalBudgetNum / 1000).toFixed(2) + 'T';
            document.getElementById('avgProgress').textContent = avgProg + '%';
        }

        function renderProjectsTable(filter) {
            var tbody = document.getElementById('projectTableBody');
            var filtered = filter === 'all' ? projects : projects.filter(function(p) { return p.status === filter; });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data"><div class="no-data-icon">üì≠</div><div class="no-data-text">No projects found</div><div class="no-data-subtext">Try a different filter</div></td></tr>';
                return;
            }

            var html = '';
            filtered.forEach(function(p, idx) {
                var statusClass = 'status-' + p.status;
                var statusText = p.status.replace('-', ' ').toUpperCase();

                html += '<tr>';
                html += '<td style="font-weight: 700; color: #64748b;">' + (idx + 1) + '</td>';
                html += '<td><strong>' + p.name + '</strong></td>';
                html += '<td>' + p.owner + '</td>';
                html += '<td>' + p.pic + '</td>';
                html += '<td><div class="progress-container"><div class="progress-bar"><div class="progress-fill" style="width: ' + p.progress + '%"></div></div><span class="progress-text">' + p.progress + '%</span></div></td>';
                html += '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>';
                html += '<td style="font-weight: 600;">' + p.budget + 'B</td>';
                html += '<td>' + p.deadline + '</td>';
                html += '<td><button class="btn-icon btn-sm" onclick="viewProject(' + p.id + ')">üìù</button></td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
            document.getElementById('activeCount').textContent = '(' + filtered.length + ')';
        }

        function renderTeamTable() {
            var teamMap = {};
            projects.forEach(function(p) {
                if (!teamMap[p.pic]) {
                    teamMap[p.pic] = { ongoing: 0, support: 0, done: 0 };
                }
                if (p.status === 'completed') teamMap[p.pic].done++;
                else teamMap[p.pic].ongoing++;
            });

            var tbody = document.getElementById('teamTableBody');
            var html = '';
            var overload = 0, balanced = 0, underload = 0;

            for (var name in teamMap) {
                var data = teamMap[name];
                var total = data.ongoing + data.done;
                var loadStatus = total > 5 ? 'Overload' : total >= 3 ? 'Balanced' : 'Underload';
                var loadClass = total > 5 ? 'status-delayed' : total >= 3 ? 'status-on-track' : 'priority-low';
                var perf = data.done > 0 ? Math.round((data.done / total) * 100) + '%' : '0%';

                if (loadStatus === 'Overload') overload++;
                else if (loadStatus === 'Balanced') balanced++;
                else underload++;

                html += '<tr>';
                html += '<td><strong>' + name + '</strong></td>';
                html += '<td>' + name.substring(0,3).toUpperCase() + '</td>';
                html += '<td>Engineering</td>';
                html += '<td style="font-weight: 700;">' + data.ongoing + '</td>';
                html += '<td>' + data.support + '</td>';
                html += '<td style="color: #10b981; font-weight: 700;">' + data.done + '</td>';
                html += '<td style="font-weight: 700;">' + total + '</td>';
                html += '<td><span class="status-badge ' + loadClass + '">' + loadStatus + '</span></td>';
                html += '<td style="font-weight: 600;">' + perf + '</td>';
                html += '</tr>';
            }

            tbody.innerHTML = html || '<tr><td colspan="9" class="no-data">No team data</td></tr>';

            document.getElementById('totalTeam').textContent = Object.keys(teamMap).length;
            document.getElementById('overloadTeam').textContent = overload;
            document.getElementById('balancedTeam').textContent = balanced;
            document.getElementById('underloadTeam').textContent = underload;
        }

        function renderOwnerTable() {
            var ownerMap = {};
            projects.forEach(function(p) {
                if (!ownerMap[p.owner]) {
                    ownerMap[p.owner] = { projects: 0, budget: 0, progress: 0, completed: 0 };
                }
                ownerMap[p.owner].projects++;
                ownerMap[p.owner].budget += parseFloat(p.budget) || 0;
                ownerMap[p.owner].progress += p.progress;
                if (p.status === 'completed') ownerMap[p.owner].completed++;
            });

            var tbody = document.getElementById('ownerTableBody');
            var html = '';
            var maxProjects = 0, maxBudget = 0, topOwner = '', topValueOwner = '';

            for (var name in ownerMap) {
                var data = ownerMap[name];
                var avgProg = Math.round(data.progress / data.projects);
                var compRate = Math.round((data.completed / data.projects) * 100);

                if (data.projects > maxProjects) {
                    maxProjects = data.projects;
                    topOwner = name;
                }
                if (data.budget > maxBudget) {
                    maxBudget = data.budget;
                    topValueOwner = name;
                }

                html += '<tr>';
                html += '<td><strong>' + name + '</strong></td>';
                html += '<td>' + name.substring(0,3).toUpperCase() + '</td>';
                html += '<td style="font-weight: 700;">' + data.projects + '</td>';
                html += '<td style="font-weight: 600;">' + data.budget.toFixed(1) + 'B</td>';
                html += '<td>' + avgProg + '%</td>';
                html += '<td style="color: #10b981; font-weight: 600;">' + compRate + '%</td>';
                html += '</tr>';
            }

            tbody.innerHTML = html || '<tr><td colspan="6" class="no-data">No owner data</td></tr>';

            document.getElementById('totalOwners').textContent = Object.keys(ownerMap).length;
            document.getElementById('topOwnerProjects').textContent = maxProjects;
            document.getElementById('topOwnerName').textContent = topOwner;
            document.getElementById('topOwnerValue').textContent = (maxBudget / 1000).toFixed(2) + 'T';
            document.getElementById('topOwnerValueName').textContent = topValueOwner;

            var highestBudget = Math.max.apply(null, projects.map(function(p) { return parseFloat(p.budget) || 0; }));
            document.getElementById('highestBudget').textContent = highestBudget.toFixed(1) + 'B';
        }

        function switchTab(tab) {
            currentTab = tab;
            var tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(function(t) { t.classList.remove('active'); });
            event.target.classList.add('active');

            document.getElementById('projectsTab').style.display = tab === 'projects' ? 'block' : 'none';
            document.getElementById('teamTab').style.display = tab === 'team' ? 'block' : 'none';
            document.getElementById('ownerTab').style.display = tab === 'owner' ? 'block' : 'none';
        }

        function filterProjects(filter) {
            currentFilter = filter;
            var chips = document.querySelectorAll('.filter-chip');
            chips.forEach(function(c) { c.classList.remove('active'); });
            event.target.classList.add('active');
            renderProjectsTable(filter);
        }

        function showMessage(type, text) {
            var container = document.getElementById('messageContainer');
            var msgClass = type === 'success' ? 'message-success' : 'message-error';
            container.innerHTML = '<div class="message ' + msgClass + '">' + text + '</div>';
            setTimeout(function() { container.innerHTML = ''; }, 5000);
        }

        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add New Project';
            document.getElementById('projectForm').reset();
            document.getElementById('projectModal').style.display = 'block';
        }

        function viewProject(id) {
            var project = projects.find(function(p) { return p.id === id; });
            if (!project) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Project';
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectOwner').value = project.owner;
            document.getElementById('projectPIC').value = project.pic;
            document.getElementById('projectProgress').value = project.progress;
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectBudget').value = project.budget;
            document.getElementById('projectDeadline').value = project.deadline;
            document.getElementById('projectNotes').value = project.notes;
            document.getElementById('projectModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function saveProject() {
            var data = {
                name: document.getElementById('projectName').value,
                owner: document.getElementById('projectOwner').value,
                pic: document.getElementById('projectPIC').value,
                progress: parseInt(document.getElementById('projectProgress').value),
                status: document.getElementById('projectStatus').value,
                budget: document.getElementById('projectBudget').value,
                deadline: document.getElementById('projectDeadline').value,
                notes: document.getElementById('projectNotes').value
            };

            if (editingId) {
                var idx = projects.findIndex(function(p) { return p.id === editingId; });
                projects[idx] = Object.assign({}, projects[idx], data);
            } else {
                var maxId = Math.max.apply(null, projects.map(function(p) { return p.id; }));
                data.id = maxId + 1;
                projects.push(data);
            }

            localStorage.setItem('projectsData', JSON.stringify(projects));
            updateAllViews();
            closeModal();
            showMessage('success', 'Project saved successfully!');
        }

        function exportToExcel() {
            showMessage('info', 'Export feature coming soon!');
        }

        window.onclick = function(e) {
            if (e.target === document.getElementById('projectModal')) closeModal();
        }
    </script>
</body>
</html>